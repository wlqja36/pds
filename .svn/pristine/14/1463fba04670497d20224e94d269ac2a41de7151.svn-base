<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="attiInfo">
	
	<typeAlias  alias="attend_InfoVO" type="nexacro.sample.vo.atticode.Attend_InfoVO"/>
	<typeAlias alias="attitudeInfoVO" type="nexacro.sample.vo.atticode.AttitudeInfoVO" />	
	<typeAlias alias="attitudeBookVO" type="nexacro.sample.vo.attitudeVO.AttitudeBookVO" />
	<typeAlias  alias="empNo" type="nexacro.sample.vo.emp.EmpVO"/>	
	
	
	<resultMap id="attend_Info" class="attend_InfoVO">
        <result property="EMP_NO"      	column="EMP_NO" />
        <result property="ATTEND_DATE"     column="ATTEND_DATE" />                                                          
        <result property="ATTITUDE_BOOK_ID"     column="ATTITUDE_BOOK_ID" />                                                          
        <result property="START_TIME"     column="START_TIME" />                                                          
        <result property="END_TIME"     column="END_TIME" />                                                          
        <result property="HOLIDAYYN"     column="HOLIDAYYN" />                                                          
        <result property="ATTEND_CODE"     column="ATTEND_CODE" />                                                          
    </resultMap> 

	<resultMap id="attitudeBook" class="attitudeBookVO">
        <result property="attitudeBookId"      	column="ATTITUDE_BOOK_ID" />
        <result property="attitudeBookName"     column="ATTITUDE_BOOK_NM" />                                                                                              
        <result property="startDate"     column="START_DATE" />                                                                                              
        <result property="endDate"     column="END_DATE" />                                                                                              
    </resultMap> 
    
    
    <resultMap id="attitudeInfo" class="attitudeInfoVO" >
    	<!-- <result property="ATTITUDE_BOOK_ID" column="ATTITUDE_BOOK_ID"/>
    	<result property="EMP_NO" column="EMP_NO"/> -->
    	<result property="NOMAL_WORK_HOURS" column="NOMAL_WORK_HOURS"/>
    	<result property="OVERTIME_HOURS" column="OVERTIME_HOURS"/>
    	<result property="HOLIDAY_WORK_HOURS" column="HOLIDAY_WORK_HOURS"/>
    	<result property="WORK_DAY_CNT" column="WORK_DAY_CNT"/>
    	<result property="LATE_CNT" column="LATE_CNT"/>
    	<result property="ABSENT_CNT" column="ABSENT_CNT"/>
    	<result property="EARLY_LEAVE_CNT" column="EARLY_LEAVE_CNT"/>
    	<result property="HOLIDAY_CNT" column="HOLIDAY_CNT"/>
    </resultMap>
    
    <resultMap id="empInfo" class="empNo">
        <result property="EMP_NO"      	column="EMP_NO" />
        <result property="EMP_NAME"     column="EMP_NAME" />
        <result property="JOIN_DATE"     column="JOIN_DATE" />                                                          
    </resultMap>
    
    
    
    <select id="attiInfo.loadAttendInfo" resultMap="attend_Info" parameterClass="attend_InfoVO">
    	SELECT 
		        (SELECT EMP_NAME||'('||EMP_NO||')' 
		        FROM EMP 
		        WHERE EMP.EMP_NO=ATTEND_INFO.EMP_NO) 
			AS EMP_NO,
		    ATTEND_DATE, 
		        (SELECT ATTITUDE_BOOK_NM||'('||ATTITUDE_BOOK_ID||')' 
		        FROM ATTITUDE_BOOK 
		        WHERE ATTITUDE_BOOK.ATTITUDE_BOOK_ID=ATTEND_INFO.ATTITUDE_BOOK_ID)
		    AS ATTITUDE_BOOK_ID, 
		        <!-- (
		        LPAD(EXTRACT(HOUR FROM CAST(START_TIME AS TIMESTAMP)),2,'0') ||':'||
		        LPAD(EXTRACT(MINUTE FROM CAST(START_TIME AS TIMESTAMP)),2,'0') ||':'||
		        LPAD(EXTRACT(SECOND FROM CAST(START_TIME AS TIMESTAMP)),2,'0')
		        )  -->
	        START_TIME,
		    END_TIME,
		    HOLIDAYYN,
		        (SELECT 
		        CODE_NAME||'('||CODE_NO||')' 
		        FROM COMMON_CODE_DETAIL 
		        WHERE ATTEND_INFO.ATTEND_CODE=COMMON_CODE_DETAIL.CODE_NO)
		    AS ATTEND_CODE 
		FROM ATTEND_INFO
		WHERE 1=1
			<!-- ATTEND_DATE BETWEEN to_date(#searchDateFrom#) AND to_date(#searchDateTo#)+1 -->
			<isNotEmpty property="searchKeyword" prepend='AND' >
				EMP_NO= 
					SUBSTR(
				        #searchKeyword#, 
				            INSTR(#searchKeyword#,'(')+1, 
				            (INSTR(#searchKeyword#,')')-1)-(INSTR(#searchKeyword#,'(')))
			</isNotEmpty>	
			<isNotEmpty property="searchCondition" prepend='AND' > 
				ATTITUDE_BOOK_ID=
					SUBSTR(
				        #searchCondition#, 
				            INSTR(#searchCondition#,'(')+1, 
				            (INSTR(#searchCondition#,')')-1)-(INSTR(#searchCondition#,'(')))
			</isNotEmpty>
		
		ORDER BY ATTEND_DATE ASC
    </select>
	
	<select id="attiInfo.loadAttitudeInfo" resultMap="attitudeInfo" parameterClass="attend_InfoVO">
		<!-- SELECT 
		     sum(LEAST(a.TOTAL_WORK_HOURS, a.NOMAL_WORK_HOURS)) AS NOMAL_WORK_HOURS
		    , sum(CASE WHEN HOLIDAYYN ='N' THEN LEAST(GREATEST(a.TOTAL_WORK_HOURS - a.NOMAL_WORK_HOURS, 0), a.OVERTIME_HOURS) ELSE 0 END) AS OVERTIME_HOURS
		    , sum(CASE WHEN HOLIDAYYN ='Y' THEN LEAST(GREATEST(a.TOTAL_WORK_HOURS - a.NOMAL_WORK_HOURS, 0), a.OVERTIME_HOURS) ELSE 0 END) AS HOLIDAY_WORK_HOURS
		    , count(a.ATTEND_CODE) TOTAL_DAY_CNT
		    , nvl(sum(a.WORK_DAY_CNT), 0) WORK_DAY_CNT
		    , nvl(sum(a.LATE_CNT), 0) LATE_CNT
		    , nvl(sum(a.ABSENT_CNT), 0) ABSENT_CNT
		    , nvl(sum(a.EARLY_LEAVE_CNT), 0) EARLY_LEAVE_CNT
		    , nvl(sum(a.HOLIDAY_CNT), 0) HOLIDAY_CNT
		FROM (
		    SELECT ATTITUDE_BOOK_ID
		            ,EMP_NO
		            , TO_CHAR(ATTEND_DATE, 'YYYY-MM-DD')  AS ATTEND_DATE
		            , TO_CHAR(START_TIME, 'YYYY-MM-DD HH24:MI')  AS START_TIME
		            , TO_CHAR(END_TIME, 'YYYY-MM-DD HH24:MI') AS END_TIME
		            , HOLIDAYYN
		            , CASE WHEN HOLIDAYYN ='Y' THEN 0 ELSE 9 END AS NOMAL_WORK_HOURS 
		            , CASE WHEN HOLIDAYYN ='Y' THEN 6 ELSE 4 END AS OVERTIME_HOURS
		            , CASE WHEN HOLIDAYYN ='Y' THEN 0 ELSE 0 END AS HOLIDAY_WORK_HOURS 
		            , FLOOR((END_TIME - START_TIME)*24) AS TOTAL_WORK_HOURS 
		            , ATTEND_CODE
		            , DECODE(ATTEND_CODE, '2110', 1, 0) AS WORK_DAY_CNT
		            , DECODE(ATTEND_CODE, '2120', 1, 0) AS LATE_CNT
		            , DECODE(ATTEND_CODE, '2130', 1, 0) AS ABSENT_CNT
		            , DECODE(ATTEND_CODE, '2140', 1, 0) AS EARLY_LEAVE_CNT
		            , DECODE(HOLIDAYYN, 'Y', 1, 0) HOLIDAY_CNT
		        FROM ATTEND_INFO
		        WHERE 1=1
		        	<isNotEmpty property="searchKeyword" prepend='AND' >
						EMP_NO= 
							SUBSTR(
						        #searchKeyword#, 
						            INSTR(#searchKeyword#,'(')+1, 
						            (INSTR(#searchKeyword#,')')-1)-(INSTR(#searchKeyword#,'(')))
					</isNotEmpty>	
					<isNotEmpty property="searchCondition" prepend='AND' > 
						ATTITUDE_BOOK_ID=
							SUBSTR(
						        #searchCondition#, 
						            INSTR(#searchCondition#,'(')+1, 
						            (INSTR(#searchCondition#,')')-1)-(INSTR(#searchCondition#,'(')))
					</isNotEmpty>
		        	) a
        group by ATTITUDE_BOOK_ID, EMP_NO -->
		
		SELECT NOMAL_WORK_HOURS
		       , NIGHT_WORK_HOURS
		       , OVERTIME_HOURS
		       , HOLIDAY_WORK_HOURS
		       , WORK_DAY_CNT
		       , LATE_CNT
		       , ABSENT_CNT
		       , EARLY_LEAVE_CNT
		       , HOLIDAY_CNT
		FROM ATTITUDE_INFO 
		WHERE 1=1
		<isNotEmpty property="searchKeyword" prepend='AND' >
			EMP_NO= 
				SUBSTR(
			        #searchKeyword#, 
			            INSTR(#searchKeyword#,'(')+1, 
			            (INSTR(#searchKeyword#,')')-1)-(INSTR(#searchKeyword#,'(')))
		</isNotEmpty>	
		<isNotEmpty property="searchCondition" prepend='AND' > 
			ATTITUDE_BOOK_ID=
				SUBSTR(
			        #searchCondition#, 
			            INSTR(#searchCondition#,'(')+1, 
			            (INSTR(#searchCondition#,')')-1)-(INSTR(#searchCondition#,'(')))
		</isNotEmpty>

	</select>
	
	
	<select id="attiInfo.loadAttendBookNo" resultMap="attitudeBook">
		SELECT 
			<!-- ATTITUDE_BOOK_NM ||'('||ATTITUDE_BOOK_ID||')' AS ATTITUDE_BOOK_ID  -->
			ATTITUDE_BOOK_ID, ATTITUDE_BOOK_NM, START_DATE, END_DATE
		FROM ATTITUDE_BOOK
	</select>
	
	
	<select id="attiInfo.searchEmp" parameterClass="attend_InfoVO" resultMap="empInfo">
		SELECT 
			EMP_NO, 
			EMP_NAME,
			JOIN_DATE 
		FROM EMP 
		WHERE EMP_NAME like '%'||#searchKeyword#||'%'
	</select> 
	
	
</sqlMap>